# 마일리지 서비스 개발

## 버전

- Java : 17
- SpringBoot : 2.7.1

## 실행 방법

### DB

- docker-compose 디렉토리로 이동 후 terminal 에서 `docker-compose up -d` 입력
  - 도커가 설치되어 있어야 한다.

### Application

- docker-compose 를 이용해 컨테이너 생성 후 어플리케이션 실행.
- Intellij 에서 실행시 profile 을 local 로 설정 후 실행
  - Edit Configurations -> active profiles 를 local 설정
- Jar 파일 생성 후 실행 
  - 프로젝트가 있는 패키지로 이동 후 `mvn clean package` 명령어 입력해 jar 파일 생성
  - `java -jar -Dspring.profiles.active=local jar파일이름` 입력해 실행

## 개발 고려사항

- 테이블 설계시 mileage 테이블의 pk를 어떻게 해야할지 오래 고민을 했습니다.
  - pk를 어떤것으로 사용할지? auto_increment vs userId
  - 타입은 어떤걸 사용할지? UUID vs auto_increment
  - 결론은  auto_increment 키를 pk로 사용하기로 했습니다.
    - uuid를 pk로 사용하고 save 시 select 쿼리가 추가로 발생하기 때문에 auto_increment를 pk로 사용

- /events api 가 리뷰 작성 이벤트 전체를 처리하는건지, 포인트만을 위한 api 인지 정했습니다
  - 해당 프로젝트에 구현된 /events 는 포인트 적립/사용, 조회를 위한 기능을 제공한다.
  - reviewID 값이 요청 파라미터로 전달되기 때문에 이미 등록되었다고 생각했습니다.
    - 예로 Review ADD 요청의 reviewId 는 이미 DB에 저장된 된 ID 값 입니다.

- 낙관적 락을 적용해 변경사항이 누락되지 않게 했습니다.

## 개발

### 1. 포인트 적립 API (/points)

리뷰 작성 이벤트가 발생시 아래 api 로 이벤트를 전달합니다

```json
POST /events

{
  "type": "REVIEW",
  "action": "ADD", /* "MOD", "DELETE" */
  "reviewId": "240a0658-dc5f-4878-9381-ebb7b2667772",
  "content": "좋아요!",
  "attachedPhotoIds": ["e4d1a64e-a531-46de-88d0-ff0ed70c0bb8", "afb0cef2-
  851d-4a50-bb07-9cc15cbdc332"],
  "userId": "3ede0ef2-92b7-4817-a5f3-0c575361f745",
  "placeId": "2e4baf1c-5acb-4efb-a1af-eddada31b00f"
}

```

- ADD
  - 리뷰 작성 요청에 따른 포인트를 적립하고 히스토리를 남기는 기능

- MOD
  - 리뷰 수정 요청에 따른 포인트를 적립,회수 하고 히스토리를 남기는 기능

- DELETE
  - 리뷰 삭제 요청에 따른 포인트를 회수하고 히스토리를 남기는 기능


### 2. 포인트 조회 API (/users/{userId}/mileage)

 회원의 현재 마일리지를 조회하는 기능

## 아쉬운점

- 파라미터 검사, 예외처리를 못했습니다.
- 동시성 검사 테스트를 하지 못했습니다.
- 멀티 인스턴스 환경에서 해당 어플리케이션을 실행한다고 하면 동시성을 보장할 수 없을 것 같습니다.
  - 분산락을 활용하면 동시성을 보장할 수 있다고 하는데 적용하지 못했습니다.
 
## 서비스 설명

- 리뷰를 작성할 때 포인트를 부여하고 개인별 포인트를 관리하는 서비스 입니다
- 한 사용자는 장소마다 리뷰를 1개 작성 가능하고 수정, 삭제가 가능합니다
  - 1자 이상 텍스트 작성 : 1점 적립
  - 1장 이상 사진 첨부 : 1점 적립
  - 특정 장소의 첫 리뷰 작성 : 1점 적립

## 상세 설명

- 포인트 증감이 있을 때마다 이력이 남아야 합니다.
- 사용자마다 현재 시점의 포인트 총점을 조회하거나 계산할 수 있어야 합니다.
- 포인트 부여 API 구현에 필요한 SQL 수행 시, 전체 테이블 스캔이 일어나지 않는 인덱스가 필요합니다.
- 리뷰를 작성했다가 삭제하면 해당 리뷰로 부여한 내용 점수와 보너스 점수는 회수합니다.
- 리뷰를 수정하면 수정한 내용에 맞는 내용 점수를 계산하여 점수를 부여하거나 회수합니다.
  - 글만 작성한 리뷰에 사진을 추가하면 1점을 부여합니다.  
  - 글과 사진이 있는 리뷰에서 사진을 모두 삭제하면 1점을 회수합니다.
- 사용자 입장에서 본 '첫 리뷰'일 때 보너스 점수를 부여합니다.
  - 어떤 장소에 사용자 A가 리뷰를 남겼다가 삭제하고, 삭제된 이후 사용자 B가 리뷰를 남기면 사
    용자 B에게 보너스 점수를 부여합니다.
  - 어떤 장소에 사용자 A가 리뷰를 남겼다가 삭제하는데, 삭제되기 이전 사용자 B가 리뷰를 남기
      면 사용자 B에게 보너스 점수를 부여하지 않습니다.


